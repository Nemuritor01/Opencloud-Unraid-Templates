## Version 2024/12/23 - Clean SWAG config without inline comments
# OpenCloud subdomain configuration for SWAG
# Place this file in: /config/nginx/proxy-confs/
# Rename to: opencloud.subdomain.conf (match your subdomain)
# Update the upstream server IP and port to match your OpenCloud container

## Version 2024/12/24 - Fixed header duplication issues
# OpenCloud subdomain configuration for SWAG
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;

    server_name opencloud.*;

    include /config/nginx/ssl.conf;

    # Increase max upload size
    client_max_body_size 10M;
    
    # Disable buffering - essential for SSE
    proxy_buffering off;
    proxy_request_buffering off;
    
    # Extend timeouts for long connections
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    keepalive_timeout 5m;
    keepalive_requests 100000;
    
    # Prevent nginx from trying other upstreams
    proxy_next_upstream off;

    location / {
        include /config/nginx/resolver.conf;
        
        set $upstream_app opencloud;
        set $upstream_port 9200;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;
        
        # Basic proxy headers - testing without SSL enforcement
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Connection upgrade for WebSocket
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }
}
